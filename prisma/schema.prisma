generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ResourceType {
  VIDEO
  ARTICLE
  LESSON
  WORKSHEET
  EXPERIMENT
}

enum ResourceStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ContentLens {
  SECULAR
}

enum UnitStatus {
  DRAFT
  ACTIVE
  COMPLETE
}

enum TrustedSourceType {
  YOUTUBE_CHANNEL
  WEBSITE
}

enum TrustTier {
  HIGH
  REVIEW_REQUIRED
}

enum SuggestedStatus {
  PENDING_REVIEW
  APPROVED
  REJECTED
  SAVED_FOR_LATER
}

model User {
  id            String         @id @default(cuid())
  name          String?
  email         String?        @unique
  emailVerified DateTime?
  image         String?
  accounts      Account[]
  sessions      Session[]
  children      ChildProfile[]
  devices       Device[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id])

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Device {
  id        String   @id @default(cuid())
  userId    String
  deviceId  String
  userAgent String
  lastSeen  DateTime @default(now())
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])

  @@unique([userId, deviceId])
}

model ChildProfile {
  id        String   @id @default(cuid())
  userId    String
  name      String
  age       Int
  readingLevel String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id])
  unitRuns  UnitRun[]
}

model Category {
  id          String   @id @default(cuid())
  name        String
  description String
  topics      Topic[]
}

model Topic {
  id          String     @id @default(cuid())
  categoryId  String
  name        String
  summary     String
  subtopics   Subtopic[]
  resources   Resource[]
  unitPlans   UnitPlan[]
  suggestedResources SuggestedResource[]
  category    Category   @relation(fields: [categoryId], references: [id])
}

model Subtopic {
  id       String   @id @default(cuid())
  topicId  String
  name     String
  summary  String
  topic    Topic    @relation(fields: [topicId], references: [id])
  resources Resource[]
  unitPlans UnitPlan[]
  suggestedResources SuggestedResource[]
}

model Resource {
  id           String         @id @default(cuid())
  url          String
  title        String
  provider     String
  type         ResourceType
  secular      Boolean        @default(true)
  contentLens  ContentLens    @default(SECULAR)
  ageMin       Int
  ageMax       Int
  watchTimeMin Int?
  summary      String
  notes        String?
  vettedBy     String?
  vettedAt     DateTime?
  status       ResourceStatus @default(PENDING)
  topicId      String
  subtopicId   String?
  transcript   String?
  topic        Topic          @relation(fields: [topicId], references: [id])
  subtopic     Subtopic?      @relation(fields: [subtopicId], references: [id])
  createdAt    DateTime       @default(now())
}

model TrustedSource {
  id                  String           @id @default(cuid())
  name                String
  type                TrustedSourceType
  trustTier           TrustTier        @default(HIGH)
  isActive            Boolean          @default(true)
  channelId           String?
  baseUrl             String?
  contentTypesAllowed String[]
  ageMin              Int              @default(5)
  ageMax              Int              @default(7)
  maxVideoMinutes     Int              @default(12)
  requireKeywords     String[]         @default([])
  blockKeywords       String[]         @default([])
  notes               String?
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  suggested           SuggestedResource[]
}

model SuggestedResource {
  id              String          @id @default(cuid())
  topicId         String
  subtopicId      String?
  trustedSourceId String
  type            ResourceType
  url             String
  title           String
  provider        String
  thumbnailUrl    String?
  durationMin     Int?
  summary         String?
  reason          String
  status          SuggestedStatus @default(PENDING_REVIEW)
  createdAt       DateTime        @default(now())
  reviewedAt      DateTime?
  reviewedBy      String?
  topic           Topic           @relation(fields: [topicId], references: [id])
  subtopic        Subtopic?       @relation(fields: [subtopicId], references: [id])
  trustedSource   TrustedSource   @relation(fields: [trustedSourceId], references: [id])
}

model UnitPlan {
  id          String     @id @default(cuid())
  topicId     String
  subtopicId  String?
  pacing      String
  ageBand     String
  readingLevel String
  status      UnitStatus @default(DRAFT)
  version     Int        @default(1)
  createdAt   DateTime   @default(now())
  topic       Topic      @relation(fields: [topicId], references: [id])
  subtopic    Subtopic?  @relation(fields: [subtopicId], references: [id])
  worksheets  Worksheet[]
  runs        UnitRun[]
}

model Worksheet {
  id         String   @id @default(cuid())
  unitPlanId String
  title      String
  content    Json
  pdfUrl     String?
  createdAt  DateTime @default(now())
  unitPlan   UnitPlan @relation(fields: [unitPlanId], references: [id])
}

model UnitRun {
  id         String     @id @default(cuid())
  unitPlanId String
  childId    String
  startedAt  DateTime   @default(now())
  completedAt DateTime?
  unitPlan   UnitPlan   @relation(fields: [unitPlanId], references: [id])
  child      ChildProfile @relation(fields: [childId], references: [id])
}

model ScienceUpdate {
  id                String   @id @default(cuid())
  title             String
  summary           String
  sourceUrl         String
  institution       String
  date              DateTime
  tags              String[]
  kidRelevanceNotes String
  status            String
  createdAt         DateTime @default(now())
}
